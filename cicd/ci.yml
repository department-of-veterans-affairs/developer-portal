version: 0.2
env:
  variables:
    GITHUB_USERNAME: me
  parameter-store:
    GITHUB_TOKEN: "/github_token"
phases:
  install:
    commands:
      - /usr/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://127.0.0.1:2375 --storage-driver=overlay2 &
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"
  pre_build:
    commands:
      - git lfs pull
      # needed for prohibit_image_files script
      - git fetch --unshallow || true 
      - mkdir -p reports
      - BRANCH=$(echo $CODEBUILD_WEBHOOK_TRIGGER | awk -F'/' '{print $2}')
      - REPO=$(echo $CODEBUILD_SOURCE_REPO_URL | sed -e 's#^https://github.com/##')
      - echo $REPO
      - PRNUM=$(prnum.sh duganth-va/developer-portal ${BRANCH:-default})
  build:
    commands:
      - ./prohibit_image_files.sh origin/master HEAD
      - cd cicd
      # run all tests
      - make test
  post_build:
    commands:
      - |
        if [[ $CODEBUILD_BUILD_SUCCEEDING -eq 0 ]] && [[ -v ${FAIL_VISUAL} ]]; then
          S3_BUCKET=liberty-devportal-visual
          aws s3 cp --no-progress reports/ s3://${S3_BUCKET}/${BRANCH}/${COMMIT_HASH}/ --recursive
          links="todo"
          docsLink = 'https://github.com/department-of-veterans-affairs/developer-portal/blob/master/docs/testing.md#visual-regression-testing'
          comment = "Visual regression testing failed. Review these diffs and then [update the snapshots](${docsLink}). <br><br> ${links}"
        elif [[ $CODEBUILD_BUILD_SUCCEEDING -eq 0 ]] 
          S3_BUCKET=liberty-devportal-reports
          aws s3 cp --no-progress reports/ s3://${S3_BUCKET}/${BRANCH}/${COMMIT_HASH}/ --recursive
          comment = "errors on build check url"
      - |
        if [[ -v $PRNUM ]]; then
          prcomment.sh duganth-va/developer-portal ${BRANCH} ${comment:-"CI success"}
