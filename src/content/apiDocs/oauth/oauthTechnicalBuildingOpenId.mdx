---
imports:
  '{ CodeWrapper, HeadingWrapper }': ../../../components 
---

<HeadingWrapper heading="Building OpenID Connect Applications" id="building-openid"/>

After being approved to use OpenID Connect, you'll receive a client id. 
- If you are building a **server-based application**, you’ll also receive a client secret and will use the [authorization code flow](link-to-Initiating-the-Auth-code-flow-on-this-page) to complete authentication. 
- If you are unable to **safely store a client secret** such as a native mobile app, you will [use PKCE](link-to-PKCE-auth-on-this-page) to complete authentication. 

### Initiating the Authorization Code Flow

**NOTE:** We provide a sample [Node.JS](https://nodejs.org/en/) application for demonstrating how to get up and running with our OAuth system. You can find the complete source code for it on our [GitHub.](https://github.com/department-of-veterans-affairs/vets-api-clients/tree/master/samples/oauth_node)

Begin the OpenID Connect authorization by using the authorization endpoint, query parameters, and scopes listed below. 

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```plaintext
https://sandbox-api.va.gov/oauth2/authorization?
 client_id=<yourClientID>
 &redirect_uri=<yourRedirectURL>
 &response_type=code
 &scope=openid offline_access profile email veteran_status.read launch/patient
 &state=1AOQK33KIfH2g0ADHvU1oWAb7xQY7p6qWnUFiG1ffcUdrbCY1DBAZ3NffrjaoBGQ&nonce=o5jYpLSe29RBHBsn5iAnMKYpYw2Iw9XRBweacc001hRo5xxJEbHuniEbhuxHfVZy

```

</CodeWrapper>


| Query Parameter            | Required     | Values                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| -------------------------- | ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| <span>client_id</span>     | **Required** | The client_id issued by the VA API Platform team                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <span>redirect_uri</span>  | **Required** | The URL you supplied. The user will be redirected to this URL after authorizing your application.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| <span>response_type</span> | **Required** | Supported response types: code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <span>state</span>         | **Required** | Ensures authorization flow integrity. See [security](#security-considerations).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| <span>scope</span>         | **Required** | Will use your application's default scopes unless you specify a smaller subset of scopes separated by a space. Review the [Scopes section](#scopes) for more information.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| <span>nonce</span>         | Optional     | Using a nonce with JWTs prevents some kinds of replay attacks where a malicious party can attempt to resend an id_token request in order to impersonate a user of your application.<p>A nonce should be generated on a per-session basis and stored on the user's client. If the user requested an id_token (by including the openid scope in the authorization request) then the [payload of the id_token](#payload) will contain a nonce value that should match the nonce value included in the authorization request.</p><p>The [OpenID Connect documentation](https://openid.net/specs/openid-connect-core-1_0.html#NonceNotes) offers the following suggestion for generating nonces:</p><p>The nonce parameter value needs to include per-session state and be unguessable to attackers. One method to achieve this for Web Server Clients is to store a cryptographically random value as an HttpOnly session cookie and use a cryptographic hash of the value as the nonce parameter. In that case, the nonce in the returned ID Token is compared to the hash of the session cookie to detect ID Token replay by third parties. A related method applicable to JavaScript Clients is to store the cryptographically random value in HTML5 local storage and use a cryptographic hash of this value. </p>                                                                      |
| <span>prompt</span>        | Optional     | Supported prompts: login, consent and none.<p>If login is specified, the user will be forced to provide credentials regardless of session state. If omitted, an existing active session with the identity provider may not require the user to provide credentials.</p><p>If consent is specified, the user will be asked to consent to their scopes being used regardless of prior consent.</p><p>If none` is specified, an application will attempt an authorization request without user interaction. When the session is invalid or there are scopes the user has not consented to, one of the following errors will be thrown: login_required or consent_required.</p> |

The Veteran will need to grant your application access permission. To do this, direct the Veteran to the URL above. The Veteran is taken through an authentication flow by VA.gov and asked to consent to your application accessing their data. The data that can be accessed is defined by your scopes. After the Veteran gives permission, your application will receive a response based on the response_type you requested

#### Authorization Code Grant

After a Veteran gives authorization for you to access their data, their browser will be redirected to your application with the response shown below, which returns the code and state parameters you must use to make a request to our authorization service. We require the state parameter for all authorization code grant flows. 

<!-- add copy button -->
<CodeWrapper>

```plaintext
GET <yourRedirectURL>?
  code=z92dapo5
  &state=af0ifjsldkj
Host: <yourRedirectHost>
```

</CodeWrapper>

Use the following format, in HTTP basic authentication, for your request using the returned code and state parameters.
- Use your client ID and client secret as the HTTP basic authentication username and password.
- Be sure to replace *< yourRedirectURL >* with the redirect URL that you provided during registration.

<!-- add copy button -->
<CodeWrapper>

```http
POST /oauth2/token HTTP/1.1
Host: sandbox-api.va.gov
Content-Type: application/x-www-form-urlencoded
Authorization: Basic {base64 encoded *client id* + ':' + *client secret*}

grant_type=authorization_code&code=z92dapo5&state=af0ifjsldkj&redirect_uri=<yourRedirectURL>
```

</CodeWrapper>

The authorization server will respond with an [access token](#id-token). If you requested the offline_access scope, you will also receive a refresh_token. The response will look like this:

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
  "access_token": "SlAV32hkKG",
  "expires_in": 3600,
  "refresh_token": "8xLOxBtZp8",
  "scope": "openid profile email offline_access",
  "patient": "1558538470",
  "state": "af0ifjsldkj",
  "token_type": "Bearer",
}
```

</CodeWrapper>

If an error occurs, you will instead receive a response like this:

<CodeWrapper>

```http
HTTP/1.1 400 Bad Request
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
  "error": "invalid_request"
}
```

</CodeWrapper>

Use the returned access_token to authorize requests to our platform by including it in the header of HTTP requests as Authorization: Bearer {access_token}. 

**NOTE:** the [access token](#id-token) will only work for the API and scopes for which you have previously initiated authorization. If you need additional scopes in the future, you will need to build a new authorization URL with the additional scopes and have the Veteran grant consent again. 

Use the refresh_token to obtain a new access_token after its expiry by sending the following request.

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```http
POST /oauth2/token HTTP/1.1
Host: sandbox-api.va.gov
Content-Type: application/x-www-form-urlencoded
Authorization: Basic {base64 encoded *client id* + ':' + *client secret*}

grant_type=refresh_token&refresh_token={your refresh_token}&scope={space separated scopes}
```

</CodeWrapper>

The response will return a new access_token and refresh_token, if you requested the offline_access scope. 

#### Manage Account

The manage endpoint directs end users to a URL where they can view which applications currently have access to their data and can make adjustments to these access rights (grants).

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```http
POST /oauth2/token HTTP/1.1
Host: sandbox-api.va.gov
```

</CodeWrapper>

#### Revoking Tokens

Clients may revoke their own access_tokens and refresh_tokens using the revoke endpoint. Once revoked, the introspection endpoint will see the token as inactive.

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```http
POST /oauth2/revoke HTTP/1.1
Host: sandbox-api.va.gov
Content-Type: application/x-www-form-urlencoded
Authorization: Basic {base64 encoded *client id* + ':' + *client secret*}

token={your access token}&token_type_hint=access_token
```

</CodeWrapper>

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```http
POST /oauth2/revoke HTTP/1.1
Host: sandbox-api.va.gov
Content-Type: application/x-www-form-urlencoded
Authorization: Basic {base64 encoded *client id* + ':' + *client secret*}

token={your refresh token}&token_type_hint=refresh_token
```

</CodeWrapper>

#### Revoking Grants

**NOTE:** This endpoint is not available in the production environment and excludes identity provider grants.

A user will be prompted only once to consent to each client's use of their data. Such a grant will remain in effect unless and until revoked. Grants for a specific user and client are revoked in the sandbox environment using the below endpoint. 

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```http
DELETE /oauth2/grants HTTP/1.1
Host: sandbox-api.va.gov
Content-Type: application/x-www-form-urlencoded

{
	"client_id": {client_id},
	"email": {test account email}
}
```

</CodeWrapper>

The client ID is your application client ID (client_id) and the email is the user’s email, which must be passed into the body of the request. Bad requests will be returned with an error response and description of the error.

<CodeWrapper>

```http
HTTP/1.1 400 Bad Request
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
  "error": "invalid_request",
  "error_description": "Invalid email address."
}
```

</CodeWrapper>

### PKCE (Proof Key for Code Exchange) Authorization

**NOTE:** We provide a [sample CLI application](https://github.com/department-of-veterans-affairs/vets-api-clients/tree/master/samples/oauth_pkce_cli) for getting started using PKCE.
Begin the OpenID Connect authorization by using the authorization endpoint, query parameters, and scopes listed below.

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```plaintext
https://sandbox-api.va.gov/oauth2/authorization?
 client_id=0oa1c01m77heEXUZt2p7
 &response_type=code
 &scope=openid profile email patient/DiagnosticReport.read
 &redirect_uri=<yourRedirectURL>
 &state=499f_073a_5094_fd7a_ff7f_0bf0_69e4_adad_2bdf_e3ab_76b9
 &code_challenge_method=S256
 &code_challenge=gNL3Mve3EVRsiFq0H6gfCz8z8IUANboT-eQZgEkXzKw

```

</CodeWrapper>

| Query Parameter                    | Required     | Values                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ---------------------------------- | ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| <span>client_id</span>             | **Required** | The client_id issued by the VA Lighthouse APIs team team                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <span>redirect_uri</span>          | **Required** | The URL you supplied. The user will be redirected to this URL after authorizing your application.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| <span>response_type</span>         | **Required** | Supported response types: code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <span>code_challenge</span>        | **Required** | Base64 encoded challenge generated from your code_verifier                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| <span>code_challenge_method</span> | **Required** | Supported code challenges: S256                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| <span>state</span>                 | **Required** | Specifying a state param helps protect against some classes of Cross Site Request Forgery (CSRF) attacks, and applications must include it. The state param will be passed back from the authorization server to your redirect URL unchanged, and your application should verify that it has the expected value. This helps assure that the client receiving the authorization response is the same as the client that initiated the authorization process.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| <span>scope</span>                 | Optional     | Will use your application's default scopes unless you specify a smaller subset of scopes separated by a space. Review the [Scopes section](#scopes) for more information.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| <span>prompt</span>                | Optional     | Supported prompts: login, consent and none.<p>If login is specified, the user will be forced to provide credentials regardless of session state. If omitted, an existing active session with the identity provider may not require the user to provide credentials.</p><p>If consent is specified, the user will be asked to consent to their scopes being used regardless of prior consent.</p><p>If none is specified, an application will attempt an authorization request without user interaction. When the session is invalid or there are scopes the user has not consented to, one of the following errors will be thrown: login_required or consent_required.</p> |

The Veteran will need to grant your application access permission. To do this, direct the Veteran to the URL above. The Veteran is taken through an authentication flow by VA.gov and asked to consent to your application accessing their data. The data that can be accessed is defined by your scopes. After the Veteran gives permission, your application will receive an authorization code.

### Authorization Code Grant
After the Veteran consents to authorize your application,  their browser will redirect to your application with the response shown below, which returns the code and state parameters you must use to make a request to our authorization service and the code_verifier used to create the code_challenge in the previous step.

<CodeWrapper>

```plaintext
 code=z92dapo5
 &state=af0ifjsldkj
Host: <yourRedirectHost>

```

</CodeWrapper>

Use the following format, in HTTP basic authentication, for your request. 
- Use the code and state parameters that were returned in the previous step.
- Be sure to replace *< yourRedirectURL >* with the redirect URL that you provided during registration. 

<!-- (Dynamic Portion Below - API selector) -->
<CodeWrapper>

```http
POST /oauth2/token HTTP/1.1
Host: sandbox-api.va.gov
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code&code=z92dapo5&state=af0ifjsldkj&redirect_uri=<yourRedirectURL>&code_verifier=ccec_bace_d453_e31c_eb86_2ad1_9a1b_0a89_a584_c068_2c96
```

</CodeWrapper>

The authorization server will send a 200 response with an [access token](#id-token). If you requested the offline_access scope, you will also receive a refresh_token. The response body will look like this, where expires_in is the time in seconds before the token expires:

<CodeWrapper>

```
{
  "access_token": "SlAV32hkKG",
  "expires_in": 3600,
  "refresh_token": "8xLOxBtZp8",
  "scope": "openid profile email offline_access",
  "state": "af0ifjsldkj",
  "token_type": "Bearer",
}
```

</CodeWrapper>

If an error occurs, you will instead receive a 400 response, like this:

<CodeWrapper>

```http
HTTP/1.1 400 Bad Request
Content-Type: application/json
Cache-Control: no-store
Pragma: no-cache

{
  "error": "invalid_request"
}
```

</CodeWrapper>

Use the returned access_token to authorize requests to our platform by including it in the header of HTTP requests as Authorization: Bearer {access_token}. 
**NOTE:** the [access token](#id-token) will only work for the API and scopes for which you have previously initiated authorization. 

Use the refresh_token to obtain a new access_token after its expiry by sending the following request.

<CodeWrapper>

```http
POST /oauth2/token HTTP/1.1
Host: sandbox-api.va.gov
Content-Type: application/x-www-form-urlencoded

grant_type=refresh_token&refresh_token={your refresh_token}&client_id={client_id}&scope={space separated scopes}
```

</CodeWrapper>

The response will return a new access_token and refresh_token, if you requested the offline_access scope. 