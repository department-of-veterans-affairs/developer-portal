import { render, screen } from '@testing-library/react';
import React from 'react';
import { MemoryRouter } from 'react-router-dom';
import { setApis } from '../../../../features/apis/apisSlice';
import store from '../../../../store';
import { fakeCategories } from '../../../../__mocks__/fakeCategories';
import * as apiQueries from '../../../../apiDefs/query';
import { APICategory, APIDescription } from '../../../../apiDefs/schema';
import { SandboxAccessSuccess } from './SandboxAccessSuccess';

describe('SandboxAccessSuccess with results', () => {
  beforeAll(() => {
    store.dispatch(setApis(fakeCategories));
  });
  describe('standard apis', () => {
    beforeEach(() => {
      const allKeyAuthApis: APIDescription[] = Object.values(fakeCategories)
        .flatMap((category: APICategory) => category.apis)
        .sort((a, b) => (a.name > b.name ? 1 : -1));

      jest.spyOn(apiQueries, 'getAllKeyAuthApis').mockReturnValue(allKeyAuthApis);
      const api = apiQueries.lookupApiBySlug('rings');
      if (!api) {
        return;
      }
      render(
        <MemoryRouter>
          <SandboxAccessSuccess
            api={api}
            result={{
              apis: ['apikey/rings'],
              clientID: 'gimli',
              clientSecret: 'sonofgloin',
              email: 'gimli@eredluin.com',
              kongUsername: 'Onering',
              redirectURI: 'http://theshire.com',
              token: 'elf-friend',
            }}
          />
        </MemoryRouter>,
      );
    });

    it('displays the API Key generated by the backend', () => {
      expect(screen.getByText('Sandbox key:')).toBeInTheDocument();
      expect(screen.getByText('elf-friend')).toBeInTheDocument();
      expect(screen.getByText('Sandbox Request ID:')).toBeInTheDocument();
      expect(screen.getByText('Onering')).toBeInTheDocument();
    });

    it('displays the provided email address', () => {
      expect(
        screen.getByText(/We sent this sandbox access information to your email address:/gm),
      ).toBeInTheDocument();
      expect(screen.getByText(/gimli@eredluin\.com/gm)).toBeInTheDocument();
    });

    it('displays confirmation for only standard APIs', () => {
      expect(screen.getByText(/Rings API/)).toBeInTheDocument();
    });
  });

  describe('oauth acg apis', () => {
    beforeEach(() => {
      const allAuthCodeApis: APIDescription[] = Object.values(fakeCategories)
        .flatMap((category: APICategory) => category.apis)
        .sort((a, b) => (a.name > b.name ? 1 : -1));

      jest.spyOn(apiQueries, 'getAllAuthCodeApis').mockReturnValue(allAuthCodeApis);
      const api = apiQueries.lookupApiBySlug('armageddon');
      if (!api) {
        return;
      }
      render(
        <MemoryRouter>
          <SandboxAccessSuccess
            api={api}
            result={{
              apis: ['acg/armageddon'],
              clientID: 'gimli',
              clientSecret: 'sonofgloin',
              email: 'gimli@eredluin.com',
              kongUsername: 'Onering',
              redirectURI: 'http://theshire.com',
              token: 'elf-friend',
            }}
          />
        </MemoryRouter>,
      );
    });

    it('displays the API OAuth Client Id generated by the backend', () => {
      expect(screen.getByText('Your VA API OAuth Client ID:')).toBeInTheDocument();
      expect(screen.getByText('gimli')).toBeInTheDocument();
    });

    it('displays the API OAuth Client Secret generated by the backend', () => {
      expect(screen.getByText('Your VA API OAuth Client Secret:')).toBeInTheDocument();
      expect(screen.getByText('sonofgloin')).toBeInTheDocument();
    });

    it('displays the provided email address', () => {
      expect(
        screen.getByText(/We sent this sandbox access information to your email address:/gm),
      ).toBeInTheDocument();
      expect(screen.getByText(/gimli@eredluin\.com/gm)).toBeInTheDocument();
    });

    it('displays confirmation for only oauth APIs', () => {
      expect(
        screen.queryByText(
          /Benefits Intake API, VA Facilities API, VA Form API, and Veteran Confirmation API/,
        ),
      ).not.toBeInTheDocument();

      expect(screen.getByText(/Armageddon API/)).toBeInTheDocument();
    });
  });

  describe('oauth ccg apis', () => {
    beforeEach(() => {
      const api = apiQueries.lookupApiBySlug('apollo-13');
      if (!api) {
        return;
      }
      render(
        <MemoryRouter>
          <SandboxAccessSuccess
            api={api}
            result={{
              apis: ['ccg/apollo13'],
              ccgClientId: 'gimli',
              email: 'gimli@eredluin.com',
              kongUsername: 'Onering',
              redirectURI: 'http://theshire.com',
              token: 'elf-friend',
            }}
          />
        </MemoryRouter>,
      );
    });

    it('displays the API OAuth Client Id generated by the backend', () => {
      expect(screen.getByText('Your VA API OAuth Client ID:')).toBeInTheDocument();
      expect(screen.getByText('gimli')).toBeInTheDocument();
    });

    it('does not display an API OAuth Client Secret', () => {
      expect(screen.queryByText('Your VA API OAuth Client Secret:')).not.toBeInTheDocument();
    });

    it('displays the provided email address', () => {
      expect(
        screen.getByText(/We sent this sandbox access information to your email address:/gm),
      ).toBeInTheDocument();
      expect(screen.getByText(/gimli@eredluin\.com/gm)).toBeInTheDocument();
    });

    it('displays confirmation for only oauth APIs', () => {
      expect(
        screen.queryByText(
          /Benefits Intake API, VA Facilities API, VA Form API, and Veteran Confirmation API/,
        ),
      ).not.toBeInTheDocument();

      expect(screen.getByText(/Apollo 13 API/)).toBeInTheDocument();
    });

    it('displays the "Important: to get production access for this API" message', () => {
      expect(
        screen.getByText(/to get production access for this API, you must either work for the VA or have specific VA agreements in place. If you have questions/),
      ).toBeInTheDocument();
    });
  });
});
