version: 0.2
env:
  variables:
    GITHUB_USERNAME: me
  parameter-store:
    GITHUB_TOKEN: "/github_token"
phases:
  install:
    commands:
      - /usr/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://127.0.0.1:2375 --storage-driver=overlay2 &
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"
  pre_build:
    commands:
      - git lfs pull
      - mkdir -p reports
      - echo "building"
      - if [ -z ${CODEBUILD_WEBHOOK_TRIGGER} ]; then echo "Webhook not set"; fi
      - BRANCH=$(echo $CODEBUILD_WEBHOOK_TRIGGER | awk -F'/' '{print $2}')
      - PRNUM=$(prnum.sh duganth-va/developer-portal ${BRANCH})
      - echo $PRNUM
  build:
    commands:
      - ./prohibit_image_files.sh origin/master HEAD
      - cd cicd
      - make test
